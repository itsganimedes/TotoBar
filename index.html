<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toto Bar - Comandas</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/headernav.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <header>
        <div class="header_info">
            <p class="title-2">Toto Bar â€“ Comandas</p>
            <p id="hiText">Hola, </p>
        </div>

        <div class="hamburger">
            <div class="hline"></div>
            <div class="hline"></div>
            <div class="hline"></div>
        </div>
    </header>

    <section id="content">

        <div class="actions oculto_mobile">
            <a class="btn" href="cocina.html">ğŸ¥– Cocina</a>
            <a class="btn" href="admin.html">ğŸ… Administrador</a>
            <a id="btnLogin" class="btn oculto" href="login.html">ğŸ’» Iniciar SesiÃ³n</a>
            <a id="btnLogout" class="btn secondary oculto">ğŸ“¤ Cerrar SesiÃ³n</a>
        </div>

        <a class="btn" id="btnNuevaComanda" href="newComanda.html">â• Nueva Orden</a>

        <h2>Comandas abiertas</h2>

        
        <div id="avisosListos"></div>


    </section>

    <footer>
        <a class="footer-btn" href="index.html">ğŸ  Inicio</a>
        <a class="footer-btn">ğŸ“‹ Ã“rdenes</a>
    </footer>

    <div id="global-loader" 
        style="
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.35);
            backdrop-filter: blur(2px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        ">
        <div style="
            padding: 20px 30px;
            background: white;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
        ">
            Procesando...
        </div>
    </div>

    <!-- CONEXION FIREBASE -->
    <script type="module" src="js/database/firebase_config.js"></script>

    <script type="module" src="js/account/signout.js"></script>
    <script type="module" src="js/general/checkAuth.js"></script>
    <script type="module" src="js/general/comandasReady.js"></script>
    <script type="module" src="js/general/index.js"></script>


    <script type="module">
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { auth, db } from "./js/database/firebase_config.js";

        import {
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            getDocs,
            getDoc,
            doc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


        function bloquearUI() {
                document.getElementById("global-loader").style.display = "flex";
                console.log("obtenido");

                // Desactivar todos los botones
                document.querySelectorAll("button").forEach(btn => {
                    btn.disabled = true;
                });
            }

            function desbloquearUI() {
                document.getElementById("global-loader").style.display = "none";

                // Reactivar botones
                document.querySelectorAll("button").forEach(btn => {
                    btn.disabled = false;
                });
            }

        export function checkAuth(loginPage = 'login.html') {

            
            onAuthStateChanged(auth, async (user) => {

                if (user) {

                    try {
                        const userDocRef = doc(db, "users", user.uid);
                        
                        const userDoc = await getDoc(userDocRef);

                        if (userDoc.exists()) {
                            const userData = userDoc.data();

                            document.getElementById("hiText").textContent = "Hola, " + userData.name;

                        } else { 
                            console.error("Documento de usuario no encontrado en Firestore. Acceso denegado.");
                            window.location.href = "index.html";
                        }

                    } catch (error) {
                        console.error("Error al obtener el rol del usuario:", error);
                        window.location.href = "login.html";
                    }
                    return;
                }
            });
        }

        checkAuth();
    </script>
</body>
</html>
